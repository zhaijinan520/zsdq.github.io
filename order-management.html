<!DOCTYPE html>
<html>
<head>
    <title>财税业务系统 - 实际可用版</title>
    <style>
        /* 基础样式 */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .btn { background: #E67E22; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>财税业务管理系统 - 实际生产版</h1>
        
        <!-- 数据备份/恢复功能 -->
        <div class="card">
            <h3>数据管理</h3>
            <button onclick="exportData()" class="btn">导出所有数据</button>
            <button onclick="importData()" class="btn">导入数据</button>
            <input type="file" id="importFile" accept=".json" style="display:none">
            <p><small>提示：定期导出数据备份，防止浏览器数据丢失</small></p>
        </div>

        <!-- 客户管理 -->
        <div class="card">
            <h3>客户管理</h3>
            <form onsubmit="addClient(event)">
                <input type="text" id="clientName" placeholder="客户名称" required>
                <input type="text" id="clientContact" placeholder="联系人" required>
                <input type="tel" id="clientPhone" placeholder="电话" required>
                <select id="clientService" required>
                    <option value="">选择服务</option>
                    <option value="registration">公司注册</option>
                    <option value="accounting">代理记账</option>
                    <option value="change">公司变更</option>
                    <option value="cancellation">公司注销</option>
                </select>
                <input type="date" id="expireDate" required>
                <button type="submit" class="btn">添加客户</button>
            </form>
            
            <table id="clientsTable">
                <thead>
                    <tr>
                        <th>客户名称</th>
                        <th>联系人</th>
                        <th>电话</th>
                        <th>服务类型</th>
                        <th>到期时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 记账服务管理 -->
        <div class="card">
            <h3>代理记账服务跟踪</h3>
            <div id="accountingServices">
                <!-- 记账服务列表 -->
            </div>
        </div>
    </div>

    <script>
        // 使用localStorage持久化存储数据
        function getStorageData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function setStorageData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // 初始化数据
        let clients = getStorageData('clients') || [];
        let accountingServices = getStorageData('accountingServices') || [];
        let tasks = getStorageData('tasks') || [];

        // 添加客户
        function addClient(event) {
            event.preventDefault();
            const client = {
                id: Date.now(),
                name: document.getElementById('clientName').value,
                contact: document.getElementById('clientContact').value,
                phone: document.getElementById('clientPhone').value,
                service: document.getElementById('clientService').value,
                expireDate: document.getElementById('expireDate').value,
                status: 'active',
                createTime: new Date().toISOString()
            };
            
            clients.push(client);
            setStorageData('clients', clients);
            renderClients();
            event.target.reset();
            
            // 如果是记账服务，自动创建记账任务
            if (client.service === 'accounting') {
                addAccountingService(client);
            }
        }

        // 添加记账服务
        function addAccountingService(client) {
            const service = {
                id: Date.now(),
                clientId: client.id,
                clientName: client.name,
                startDate: new Date().toISOString().split('T')[0],
                // 默认一年服务期
                endDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                monthlyTasks: generateMonthlyTasks(client.id, client.name),
                status: 'active'
            };
            
            accountingServices.push(service);
            setStorageData('accountingServices', accountingServices);
            renderAccountingServices();
        }

        // 生成月度记账任务
        function generateMonthlyTasks(clientId, clientName) {
            const tasks = [];
            const now = new Date();
            
            for (let i = 0; i < 12; i++) {
                const month = new Date(now.getFullYear(), now.getMonth() + i, 15);
                tasks.push({
                    month: month.toISOString().split('T')[0],
                    status: i === 0 ? 'pending' : 'upcoming',
                    completed: false,
                    accountant: ''
                });
            }
            
            return tasks;
        }

        // 数据导出
        function exportData() {
            const data = {
                clients: clients,
                accountingServices: accountingServices,
                tasks: tasks,
                exportTime: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `财税系统备份_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 数据导入
        function importData() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('确认导入数据？这将覆盖当前所有数据！')) {
                        clients = data.clients || [];
                        accountingServices = data.accountingServices || [];
                        tasks = data.tasks || [];
                        
                        setStorageData('clients', clients);
                        setStorageData('accountingServices', accountingServices);
                        setStorageData('tasks', tasks);
                        
                        renderClients();
                        renderAccountingServices();
                        alert('数据导入成功！');
                    }
                } catch (error) {
                    alert('文件格式错误！');
                }
            };
            
            reader.readAsText(file);
        });

        // 渲染函数
        function renderClients() {
            const tbody = document.querySelector('#clientsTable tbody');
            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td>${client.name}</td>
                    <td>${client.contact}</td>
                    <td>${client.phone}</td>
                    <td>${getServiceText(client.service)}</td>
                    <td>${client.expireDate}</td>
                    <td>
                        <button onclick="editClient(${client.id})">编辑</button>
                        <button onclick="deleteClient(${client.id})">删除</button>
                        ${client.service === 'accounting' ? 
                         `<button onclick="viewAccountingTasks(${client.id})">查看记账</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function renderAccountingServices() {
            const container = document.getElementById('accountingServices');
            container.innerHTML = accountingServices.map(service => `
                <div class="service-item">
                    <h4>${service.clientName} - 记账服务</h4>
                    <p>服务期: ${service.startDate} 至 ${service.endDate}</p>
                    <div class="monthly-tasks">
                        ${service.monthlyTasks.map(task => `
                            <div class="task ${task.status}">
                                ${task.month}月记账 
                                <span class="status">${getTaskStatusText(task.status)}</span>
                                ${task.status === 'pending' ? 
                                 `<button onclick="completeTask(${service.id}, '${task.month}')">完成</button>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // 工具函数
        function getServiceText(service) {
            const map = {
                'registration': '公司注册',
                'accounting': '代理记账',
                'change': '公司变更',
                'cancellation': '公司注销'
            };
            return map[service] || service;
        }

        function getTaskStatusText(status) {
            const map = {
                'pending': '待处理',
                'completed': '已完成',
                'upcoming': '未开始'
            };
            return map[status] || status;
        }

        // 初始化渲染
        renderClients();
        renderAccountingServices();
    </script>
</body>
</html>